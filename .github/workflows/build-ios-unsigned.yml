name: Build iOS (Unsigned/AdHoc)

on:
  push:
    branches: ["main", "IOSTest"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: macos-latest

    env:
      IOS_DIR: iosApp
      SCHEME: KawaiiRawEditor
      CONFIG: Debug
      PROJECT: KawaiiRawEditor.xcodeproj
      ARCHIVE_PATH: build/ios/KawaiiRawEditor.xcarchive
      OUT_DIR: build_artifacts

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java (for Gradle/KMP)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Optional: only if your iOS app depends on a KMP :shared framework being built first
      - name: Build KMP iOS framework (optional)
        run: ./gradlew :shared:linkDebugFrameworkIosArm64 || true

      - name: Archive iOS app (unsigned)
        run: |
          set -euo pipefail
          xcodebuild \
            -project "${IOS_DIR}/${PROJECT}" \
            -scheme "${SCHEME}" \
            -configuration "${CONFIG}" \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath "${ARCHIVE_PATH}" \
            archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM=""

      - name: Package IPA (unsigned)
        run: |
          set -euo pipefail
          rm -rf "${OUT_DIR}"
          mkdir -p "${OUT_DIR}/Payload"

          APP_PATH="${ARCHIVE_PATH}/Products/Applications/${SCHEME}.app"
          cp -R "${APP_PATH}" "${OUT_DIR}/Payload/"
          (cd "${OUT_DIR}" && /usr/bin/zip -r "${SCHEME}-unsigned.ipa" Payload)

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-unsigned
          path: build_artifacts/*.ipa
          if-no-files-found: error
