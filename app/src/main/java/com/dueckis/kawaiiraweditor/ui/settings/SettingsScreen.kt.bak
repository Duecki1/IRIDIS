@file:OptIn(androidx.compose.material3.ExperimentalMaterial3Api::class)

package com.dueckis.kawaiiraweditor.ui.settings

import android.content.Intent
import android.net.Uri
import android.widget.Toast
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.WindowInsets
        when (activeSection) {
            SettingsSection.Main -> MainSettings(padding)
            SettingsSection.Ai -> AiSettings(padding)
            SettingsSection.Immich -> ImmichSettings(padding)
        }
            )

            if (immichAuthMode == ImmichAuthMode.Login) {
                val loginSupporting = when {
                    immichServerUrl.isBlank() -> "Set the server URL first."
                    immichAccessToken.isNotBlank() -> {
                        if (immichLoginEmail.isNotBlank()) "Signed in as $immichLoginEmail" else "Signed in"
                    }
                    else -> "Tap to log in."
                }
                ListItem(
                    headlineContent = { Text("Immich account") },
                    supportingContent = {
                        Text(
                            text = loginSupporting,
                            Scaffold(
                                modifier = Modifier
                                    .fillMaxSize()
                                    .windowInsetsPadding(WindowInsets.systemBars),
                                topBar = {
                                    CenterAlignedTopAppBar(
                                        title = { Text(topBarTitle, fontWeight = FontWeight.SemiBold) },
                                        navigationIcon = {
                                            val onNavClick: () -> Unit = if (isMainSection) onBackClick else {
                                                { activeSection = SettingsSection.Main }
                                            }
                                            IconButton(onClick = onNavClick) {
                                                Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = "Back")
                                            }
                                        },
                                        actions = {
                                            if (isMainSection) {
                                                IconButton(onClick = { showInfoDialog = true }) {
                                                    Icon(Icons.Default.Info, contentDescription = "App Info")
                                                }
                                            }
                                        }
                                    )
                                }
                            ) { padding ->
                                when (activeSection) {
                                    SettingsSection.Main -> MainSettings(padding)
                                    SettingsSection.Ai -> AiSettings(padding)
                                    SettingsSection.Immich -> ImmichSettings(padding)
                                }
                        "Used as quick-pick suggestions when renaming masks.",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                },
                trailingContent = { Text("${maskRenameTags.size}") },
                modifier = Modifier.clickable {
                    maskTagsDraft = maskRenameTags.joinToString("\n")
                    showMaskTagsDialog = true
                }
            )

            if (showMaskTagsDialog) {
                AlertDialog(
                    onDismissRequest = { showMaskTagsDialog = false },
                    title = { Text("Mask rename tags") },
                    text = {
                        OutlinedTextField(
                            value = maskTagsDraft,
                            onValueChange = { maskTagsDraft = it },
                            label = { Text("One tag per line") },
                            minLines = 6
                        )
                    },
                    confirmButton = {
                        TextButton(onClick = {
                            val tags =
                                maskTagsDraft
                                    .lines()
                                    .map { it.trim() }
                                    .filter { it.isNotEmpty() }
                                    .distinct()
                            onMaskRenameTagsChange(tags)
                            showMaskTagsDialog = false
                        }) { Text("Save") }
                    },
                    dismissButton = {
                        TextButton(onClick = { showMaskTagsDialog = false }) { Text("Cancel") }
                    }
                )
            }

            if (showImmichServerDialog) {
                AlertDialog(
                    onDismissRequest = { showImmichServerDialog = false },
                    title = { Text("Immich server") },
                    text = {
                        OutlinedTextField(
                            value = immichServerDraft,
                            onValueChange = { immichServerDraft = it },
                            label = { Text("Server URL") },
                            singleLine = true
                        )
                    },
                    confirmButton = {
                        TextButton(onClick = {
                            onImmichServerUrlChange(immichServerDraft)
                            showImmichServerDialog = false
                        }) { Text("Save") }
                    },
                    dismissButton = {
                        TextButton(onClick = { showImmichServerDialog = false }) { Text("Cancel") }
                    }
                )
            }

            if (showImmichApiKeyDialog) {
                AlertDialog(
                    onDismissRequest = { showImmichApiKeyDialog = false },
                    title = { Text("Immich API key") },
                    text = {
                        OutlinedTextField(
                            value = immichApiKeyDraft,
                            onValueChange = { immichApiKeyDraft = it },
                            label = { Text("API key") },
                            singleLine = true
                        )
                    },
                    confirmButton = {
                        TextButton(onClick = {
                            onImmichApiKeyChange(immichApiKeyDraft)
                            showImmichApiKeyDialog = false
                        }) { Text("Save") }
                    },
                    dismissButton = {
                        TextButton(onClick = { showImmichApiKeyDialog = false }) { Text("Cancel") }
                    }
                )
            }

            if (showImmichLoginDialog) {
                AlertDialog(
                    onDismissRequest = { showImmichLoginDialog = false },
                    title = { Text("Immich login") },
                    text = {
                        Column {
                            OutlinedTextField(
                                value = immichEmailDraft,
                                onValueChange = { immichEmailDraft = it },
                                label = { Text("Email") },
                                singleLine = true
                            )
                            Spacer(modifier = Modifier.height(12.dp))
                            OutlinedTextField(
                                value = immichPasswordDraft,
                                onValueChange = { immichPasswordDraft = it },
                                label = { Text("Password") },
                                singleLine = true,
                                visualTransformation = PasswordVisualTransformation()
                            )
                            Spacer(modifier = Modifier.height(12.dp))
                            TextButton(
                                enabled = !immichOauthInFlight,
                                onClick = {
                                    val server = immichServerUrl.trim()
                                    if (server.isBlank()) {
                                        Toast.makeText(context, "Set the server URL first.", Toast.LENGTH_SHORT).show()
                                        return@TextButton
                                    }
                                    immichOauthInFlight = true
                                    immichLoginError = null
                                    coroutineScope.launch {
                                        val result = onImmichOAuthStart(server)
                                        immichOauthInFlight = false
                                        val authUrl = result?.authorizationUrl
                                        if (authUrl.isNullOrBlank()) {
                                            immichLoginError = result?.errorMessage ?: "OAuth login failed."
                                            return@launch
                                        }
                                        val intent = Intent(Intent.ACTION_VIEW, Uri.parse(authUrl))
                                        val launched = runCatching { context.startActivity(intent) }.isSuccess
                                        if (launched) {
                                            showImmichLoginDialog = false
                                            Toast.makeText(context, "Finish logging in with Immich.", Toast.LENGTH_SHORT)
                                                .show()
                                        } else {
                                            immichLoginError = "Could not open the browser."
                                        }
                                    }
                                }
                            ) { Text(if (immichOauthInFlight) "Opening browser..." else "Log in with browser") }
                            if (immichLoginError != null) {
                                Spacer(modifier = Modifier.height(8.dp))
                                Text(
                                    text = immichLoginError ?: "",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.error
                                )
                            }
                        }
                    },
                    confirmButton = {
                        TextButton(
                            enabled = !immichLoginInFlight,
                            onClick = {
                                val server = immichServerUrl.trim()
                                if (server.isBlank()) {
                                    Toast.makeText(context, "Set the server URL first.", Toast.LENGTH_SHORT).show()
                                    return@TextButton
                                }
                                if (immichEmailDraft.isBlank() || immichPasswordDraft.isBlank()) {
                                    Toast.makeText(context, "Enter email and password.", Toast.LENGTH_SHORT).show()
                                    return@TextButton
                                }
                                immichLoginInFlight = true
                                immichLoginError = null
                                coroutineScope.launch {
                                    val result = onImmichLogin(server, immichEmailDraft, immichPasswordDraft)
                                    immichLoginInFlight = false
                                    val token = result?.accessToken
                                    if (token.isNullOrBlank()) {
                                        immichLoginError = result?.errorMessage ?: "Login failed."
                                    } else {
                                        onImmichLoginEmailChange(immichEmailDraft)
                                        onImmichAccessTokenChange(token)
                                        immichPasswordDraft = ""
                                        showImmichLoginDialog = false
                                        Toast.makeText(context, "Logged in.", Toast.LENGTH_SHORT).show()
                                    }
                                }
                            }
                        ) { Text(if (immichLoginInFlight) "Logging in..." else "Log in") }
                    },
                    dismissButton = {
                        TextButton(onClick = { showImmichLoginDialog = false }) { Text("Cancel") }
                    }
                )
            }

        }
    }

    if (showInfoDialog) {
        AboutDialog(onDismissRequest = { showInfoDialog = false })
    }
}
